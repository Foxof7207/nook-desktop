const request=require("superagent"),$=window.jQuery,Nanobar=window.Nanobar,CustomEvent=window.CustomEvent,confirm=window.confirm,u=window.crypto.randomUUID();let i18n,blinkers,paused=!1,language="en";const translations={en:require("./i18n/Nook_English.json"),es:require("./i18n/Nook_Spanish.json"),de:require("./i18n/Nook_German.json"),it:require("./i18n/Nook_Italian.json"),fr:require("./i18n/Nook_French.json"),cn:require("./i18n/Nook_Chinese.json")},changelog=require("../release-log.json"),kkSongs=require("../kk.json"),kkHtml=()=>{let n="";return kkSongs.forEach(e=>{n+=`<label><input type="checkbox" class="kkSong" data-title="${e}" />${e}</label>`}),n},replaceDataInit={offlineKKFiles:0,offlineFiles:0,totalKKFiles:193,totalFiles:294},replaceDataObs={set(n,e,a){n[e]=a,$(`[data-i18n*="${e}"]`).each((n,t)=>{$(t).html(i18n($(t).attr("data-i18n")).replace(e,a))})}},replaceData=new Proxy(replaceDataInit,replaceDataObs),tunes=["zZz","-","G0","A1","B1","C1","D1","E1","F1","G1","A2","B2","C2","D2","E2","?"];let nanobar;const template=`\n<div class="container overlay">\n  <div class="error"><div></div></div>\n  <div class="header">\n      <div class="title">\n          <span id="openGithub" role="link" data-i18n-title="Nook GitHub">nook</span>\n          <button id="pause" data-i18n-title="Pause" data-i18n-title-alt="Play"></button>\n          <button id="home" class="hidden" data-i18n-title="Home" role="link"></button>\n          <button id="settings" data-i18n-title="Settings" role="link"></button>\n      </div>\n      <div class="buttonbox">\n          <button id="close" data-i18n-title="Minimize to tray"></button>\n          <button id="exit" data-i18n-title="Exit Nook"></button>\n      </div>\n  </div>\n  <div class="main">\n      <div class="home page">\n          <div class="controls">\n              <label>\n                  <span data-i18n="Music Volume"></span>\n                  <input id="music" type="range" step="1" min="0" max="100" />\n              </label>\n              <label>\n                  <span data-i18n="Rain Volume"></span>\n                  <input id="rain" type="range" step="1" min="0" max="100" />\n              </label>\n          </div>\n          <div class="game-select">\n              <select id="gameSelect">\n                  <option value="population-growing" data-i18n="AC: Population Growing (GC)"></option>\n                  <option value="population-growing-snowy" data-i18n="AC: Population Growing (GC) [Snowy]"></option>\n                  <option value="population-growing-cherry" data-i18n="AC: Population Growing (GC) [Sakura]"></option>\n                  <option value="population-growing-rainy" data-i18n="AC: Population Growing (GC) [Rainy Day]"></option>\n                  <option value="wild-world" data-i18n="AC: City Folk (Wii)"></option>\n                  <option value="wild-world-rainy" data-i18n="AC: City Folk (Wii) [Rainy]"></option>\n                  <option value="wild-world-snowy" data-i18n="AC: City Folk (Wii) [Snowy]">}</option>\n                  <option value="new-leaf" selected data-i18n="AC: New Leaf (3DS)"></option>\n                  <option value="new-leaf-rainy" data-i18n="AC: New Leaf (3DS) [Rainy]"></option>\n                  <option value="new-leaf-snowy" data-i18n="AC: New Leaf (3DS) [Snowy]"></option>\n                  <option value="new-horizons" data-i18n="AC: New Horizons (Switch)"></option>\n                  <option value="new-horizons-rainy" data-i18n="AC: New Horizons (Switch) [Rainy]"></option>\n                  <option value="new-horizons-snowy" data-i18n="AC: New Horizons (Switch) [Snowy]"></option>\n                  <option value="pocket-camp" data-i18n="AC: Pocket Camp (Mobile)"></option>\n                  <optgroup label="&nbsp;"></optgroup>\n                  <option value="kk-slider-desktop" data-i18n="K.K. Slider"></option>\n                  <option value="random" data-i18n="Random"></option>\n              </select>    \n          </div>\n          <div class="bottom-support">\n            <button id="changelog" data-i18n="changelog" data-i18n-title="changelog"></button>\n          </div>\n      </div>\n      <div class="settings page hidden">\n          <p data-i18n="player settings" role="heading" aria-level="1"></p>\n          <label>\n              <input id="grandFather" type="checkbox"/>\n              <span data-i18n="Grandfather clock mode"></span> <span class="tiny" data-i18n="(plays once, no loop)"></span>\n          </label>\n          <label>\n              <input class="rains" id="gameRain" type="checkbox"/>\n              <span data-i18n="Use game rain sound"></span>\n          </label>\n          <label>\n              <input class="rains" id="peacefulRain" type="checkbox"/>\n              <span data-i18n="Use no-thunder rain sound"></span>\n          </label>\n          <label>\n              <input id="preferNoDownload" type="checkbox"/>\n              <span data-i18n="Don't download music"></span> <span class="tiny" data-i18n="(saves space, but no offline)"></span>\n          </label>\n          <div class="towntune-setting">\n            <label>\n                <input id="townTune" type="checkbox"/>\n                <span data-i18n="Enable town tune"></span>\n            </label>\n          </div>\n          <label class="kk-label">\n            <input id="kkSaturday" type="checkbox"/>\n            <span data-i18n="Play K.K. music on Saturday nights"></span>\n          </label>\n          <label>\n              <input id="openOnStartup" type="checkbox"/>\n              <span data-i18n="Open on startup"></span>\n          </label>\n          <div class="btnContainer">\n            <button id="kkCustomize" data-i18n="customize k.k. playlist"></button>\n            <button class="towntune-custom" id="towntune_customize" data-i18n="customize town tune"></button>\n          </div>\n          <label class="lang-label">\n            <p data-i18n="language"></p>\n              <select id="langSelect">\n                <option value="en">\n                    English (US)\n                </option>\n                <option value="es">\n                    Spanish/Español (ES)\n                </option>\n                <option value="de">\n                    German/Deutsch (DE)\n                </option>\n                <option value="it">\n                    Italian/Italiano (IT)\n                </option>\n                <option value="fr">\n                    French/Français (FR)\n                </option>\n                <option value="cn">\n                    Chinese/中文 (CN)\n                </option>\n              </select>\n          </label>\n          <p class="offline" data-i18n="offline" role="heading" aria-level="2"></p>\n          <span class="offlineCount" data-i18n="{{offlineFiles}}/{{totalFiles}} offline hourly music files downloaded"></span>\n          <span class="offlineCount" data-i18n="{{offlineKKFiles}}/{{totalKKFiles}} offline k.k. music files downloaded"></span>\n          <div class="btnContainer">\n            <button class="download" id="downloadHourly" data-i18n="download all hourly music" data-i18n-alt="downloading..."></button>\n            <button class="download" id="downloadKK" data-i18n="download all k.k. music" data-i18n-alt="downloading..."></button>\n          </div>\n          <div class="btnContainer">\n              <button id="clearSettings" data-i18n="clear local files and settings"></button>\n          </div>\n      </div>\n      <div class="kk-customize page hidden">\n          <p data-i18n="k.k. playlist" role="heading" aria-level="1"></p>\n          <div class="kk-btn btnContainer">\n            <button id="save_kk" data-i18n="save" data-i18n-alt="saved!"></button>\n            <button id="check_kk" data-i18n="check all"></button>\n            <button id="uncheck_kk" data-i18n="uncheck all"></button>\n            <button id="radio_kk" data-i18n="radio only"></button>\n            <button id="live_kk" data-i18n="live only"></button>\n          </div>\n          <div class="playlist">\n            ${kkHtml()}\n          </div>\n      </div>\n      <div class="tune-settings page hidden">\n          <p data-i18n="tune settings" role="heading" aria-level="1"></p>\n          <div class="creator">\n            <div class="inputs">\n              <label>\n                <input type="range" class="tune-slider" step="1" min="1" max="16">\n                <span></span>\n              </label>\n              <label>\n                <input type="range" class="tune-slider" step="1" min="1" max="16">\n                <span></span>\n              </label>\n              <label>\n                <input type="range" class="tune-slider" step="1" min="1" max="16">\n                <span></span>\n              </label>\n              <label>\n                <input type="range" class="tune-slider" step="1" min="1" max="16">\n                <span></span>\n              </label>\n              <label>\n                <input type="range" class="tune-slider" step="1" min="1" max="16">\n                <span></span>\n              </label>\n              <label>\n                <input type="range" class="tune-slider" step="1" min="1" max="16">\n                <span></span>\n              </label>\n              <label>\n                <input type="range" class="tune-slider" step="1" min="1" max="16">\n                <span></span>\n              </label>\n              <label>\n                <input type="range" class="tune-slider" step="1" min="1" max="16">\n                <span></span>\n              </label>\n              <label>\n                <input type="range" class="tune-slider" step="1" min="1" max="16">\n                <span></span>\n              </label>\n              <label>\n                <input type="range" class="tune-slider" step="1" min="1" max="16">\n                <span></span>\n              </label>\n              <label>\n                <input type="range" class="tune-slider" step="1" min="1" max="16">\n                <span></span>\n              </label>\n              <label>\n                <input type="range" class="tune-slider" step="1" min="1" max="16">\n                <span></span>\n              </label>\n              <label>\n                <input type="range" class="tune-slider" step="1" min="1" max="16">\n                <span></span>\n              </label>\n              <label>\n                <input type="range" class="tune-slider" step="1" min="1" max="16">\n                <span></span>\n              </label>\n              <label>\n                <input type="range" class="tune-slider" step="1" min="1" max="16">\n                <span></span>\n              </label>\n              <label>\n                <input type="range" class="tune-slider" step="1" min="1" max="16">\n                <span></span>\n              </label>\n            </div>\n          </div>\n          <div class="tips">\n            <p data-i18n="tip: you can use the mouse wheel to adjust notes!"></p>\n          </div>\n          <div class="save-tune-btn btnContainer">\n            <button id="save_tune" data-i18n="save" data-i18n-alt="saved!"></button>\n            <button id="play_tune" data-i18n="play" data-i18n-alt="playing..."></button>\n          </div>\n      </div>\n      <div class="changelog page hidden">\n          <p data-i18n="changelog" role="heading" aria-level="1"></p>\n          <div class="log"></div>\n      </div>\n  </div>\n</div>\n`,pause=n=>{const e=$("#pause");n?(e.addClass("paused"),e.text(""),e.attr("title",i18n(e.attr("data-i18n-title-alt")))):(e.removeClass("paused"),e.text(""),e.attr("title",i18n(e.attr("data-i18n-title"))))},setCooldown=()=>{$(".settings").find("input, button, select").attr("disabled",!0),setTimeout(()=>{$(".settings").find("input, button, select").removeAttr("disabled")},300)},changeLang=(n,e,a)=>{let t;language=n,i18n=e=>{let a=translations[n][e];return a||(console.error(`${n} translation missing for "${e}"`),a=translations.en[e]),a||(console.error(`translation missing for "${e}"`),a=e),Object.entries(replaceData).forEach(n=>{a=a.replaceAll(`{{${n[0]}}}`,n[1])}),a},t=$(e?"body":template),t.find("[data-i18n-title]").each((n,e)=>{$(e).attr("title",i18n($(e).attr("data-i18n-title")))}),t.find("[data-i18n]").each((n,e)=>{$(e).html(i18n($(e).attr("data-i18n")))});let i="";Object.keys(changelog).forEach(n=>{i+=`<p>${n}</p><ul><li>${changelog[n].join("</li><li>")}</li></ul>`}),t.find(".log").html(i),e||$(".glass-container").append(t),e||setTimeout(()=>{exec(),$(".container").addClass("visible"),$("#music").val(a.soundVol),$("#rain").val(a.rainVol),$("#grandFather").prop("checked",a.grandFather),$("#gameRain").prop("checked",a.gameRain),$("#peacefulRain").prop("checked",a.peacefulRain),$("#gameSelect").val(a.game),$("#langSelect").val(a.lang),$("#townTune").prop("checked",a.tuneEnabled),$("#preferNoDownload").prop("checked",a.preferNoDownload),$("#kkSaturday").prop("checked",a.kkSaturday),$("#openOnStartup").prop("checked",a.openOnStartup),a.kkEnabled.forEach(n=>{$(`.kk-customize input[data-title="${n}"]`).prop("checked",!0)}),paused=a.paused,pause(a.paused),$(".creator .inputs label").each((n,e)=>{const t=$(e);t.find("input").val(tunes.indexOf(a.tune[n])+1),t.find("input").attr("c",t.find("input").val())}),a.showChangelog&&showChangelog()},0)},showChangelog=()=>{$("#changelog").click()},logVis=n=>{request.post("https://www.google-analytics.com/mp/collect").query({api_secret:"V8GvDmXcQmWaAM6HGa0nDg",measurement_id:"G-3Y8P169K9E"}).send(JSON.stringify({client_id:u,user_properties:{language:{value:language}},events:[{name:"page_view",params:{page_title:n,page_location:`https://mat.dog/nook/${n}`,engagement_time_msec:"5",session_id:u}}]})).catch(n=>{console.error("Analytics error:",n)})},exec=()=>{logVis("home"),$("#close").on("click",()=>{window.electronAPI.send("min")}),$("#exit").on("click",()=>{window.electronAPI.send("close")}),$("#pause").on("click",()=>{paused=!paused,pause(paused),window.electronAPI.send("toPlayer",["paused",paused])}),$(".title #openGithub").on("click",n=>{logVis("github"),window.electronAPI.send("github")}),$("#changelog").on("click",()=>{logVis("changelog"),$(".page").addClass("hidden"),$(".changelog.page").removeClass("hidden"),$("#settings").addClass("hidden"),$("#home").removeClass("hidden").focus()}),$("#towntune_customize").on("click",()=>{logVis("towntune"),$(".page").addClass("hidden"),$(".tune-settings.page").removeClass("hidden"),$("#home").addClass("hidden"),$("#settings").removeClass("hidden").focus()}),$("#kkCustomize").on("click",()=>{logVis("kkCustomize"),$(".page").addClass("hidden"),$(".kk-customize.page").removeClass("hidden"),$("#home").addClass("hidden"),$("#settings").removeClass("hidden").focus()}),$("#music").on("change",n=>{window.electronAPI.send("toPlayer",["musicVol",n.target.value])}),$("#rain").on("change",n=>{window.electronAPI.send("toPlayer",["rainVol",n.target.value])}),$("#gameSelect").on("change",n=>{window.electronAPI.send("toPlayer",["game",n.target.value])}),$("#settings").on("click",()=>{logVis("settings"),$(".page").addClass("hidden"),$(".settings.page").removeClass("hidden"),$("#settings").addClass("hidden"),$("#home").removeClass("hidden").focus()}),$("#home").on("click",()=>{logVis("home"),$(".page").addClass("hidden"),$(".home.page").removeClass("hidden"),$("#home").addClass("hidden"),$("#settings").removeClass("hidden").focus()}),$(".settings #grandFather").on("change",n=>{window.electronAPI.send("toPlayer",["grandFather",n.target.checked]),setCooldown()}),$(".settings #gameRain").on("change",n=>{window.electronAPI.send("toPlayer",["gameRain",n.target.checked]),$("#peacefulRain").prop("checked",!1),setCooldown()}),$(".settings #peacefulRain").on("change",n=>{window.electronAPI.send("toPlayer",["peacefulRain",n.target.checked]),$("#gameRain").prop("checked",!1),setCooldown()}),$(".settings #townTune").on("change",n=>{window.electronAPI.send("toPlayer",["tuneEnabled",n.target.checked]),setCooldown()}),$(".settings #preferNoDownload").on("change",n=>{window.electronAPI.send("toPlayer",["preferNoDownload",n.target.checked]),setCooldown()}),$(".settings #kkSaturday").on("change",n=>{window.electronAPI.send("toPlayer",["kkSaturday",n.target.checked]),setCooldown()}),$(".settings #openOnStartup").on("change",n=>{window.electronAPI.send("toPlayer",["openOnStartup",n.target.checked]),setCooldown()}),$(".settings #langSelect").on("change",n=>{changeLang(n.target.value,!0),window.electronAPI.send("toPlayer",["lang",n.target.value])}),$(".settings #clearSettings").on("click",n=>{confirm(`${i18n("Are you sure?")}\n\n${i18n('Click "OK" to proceed and delete all local music files and user settings.')}`)&&window.electronAPI.send("clearSettings")}),$(".settings #downloadHourly").on("click",n=>{$(n.currentTarget).text(i18n($(n.currentTarget).attr("data-i18n-alt"))),$(".settings .download").attr("disabled","true"),window.electronAPI.send("toPlayer",["downloadHourly"]),setCooldown()}),$(".settings #downloadKK").on("click",n=>{$(n.currentTarget).text(i18n($(n.currentTarget).attr("data-i18n-alt"))),$(".settings .download").attr("disabled","true"),window.electronAPI.send("toPlayer",["downloadKK"]),setCooldown()}),$(".kk-customize #save_kk").on("click",n=>{const e=[];$(".kk-customize input").each((n,a)=>{!0===$(a).prop("checked")&&e.push($(a).attr("data-title"))}),window.electronAPI.send("toPlayer",["kkEnabled",e]),$(n.currentTarget).text(i18n($(n.currentTarget).attr("data-i18n-alt"))),setTimeout(()=>{$(n.currentTarget).text(i18n($(n.currentTarget).attr("data-i18n")))},1e3)}),$(".kk-customize #check_kk").on("click",()=>{$(".kk-customize input").prop("checked",!0)}),$(".kk-customize #uncheck_kk").on("click",()=>{$(".kk-customize input").prop("checked",!1)}),$(".kk-customize #live_kk").on("click",()=>{$(".kk-customize label").not(":contains(Radio)").find("input").prop("checked",!0),$(".kk-customize label").filter(":contains(Radio)").find("input").prop("checked",!1)}),$(".kk-customize #radio_kk").on("click",()=>{$(".kk-customize label").filter(":contains(Radio)").find("input").prop("checked",!0),$(".kk-customize label").not(":contains(Radio)").find("input").prop("checked",!1)}),$('.tune-settings input[type="range"]').on("wheel",n=>{n.preventDefault(),n.stopPropagation(),n.originalEvent.deltaY<0?n.currentTarget.valueAsNumber+=1:n.currentTarget.value-=1,n.currentTarget.dispatchEvent(new CustomEvent("input"))}),$('.tune-settings input[type="range"]').on("click",n=>{n.currentTarget.dispatchEvent(new CustomEvent("input"))}),$('.tune-settings input[type="range"]').on("input",n=>{const e=$(n.currentTarget);window.electronAPI.send("toPlayer",["playNote",e.val()]),e.attr("c",e.val())}),$("#save_tune").on("click",()=>{const n=$("#save_tune"),e=[];$('.tune-settings input[type="range"]').each((n,a)=>{e.push(tunes[$(a).val()-1])}),window.electronAPI.send("toPlayer",["tune",e]),n.text(i18n(n.attr("data-i18n-alt"))),setTimeout(()=>{n.text(i18n(n.attr("data-i18n")))},1e3)}),$("#play_tune").on("click",()=>{clearInterval(blinkers);const n=[];$('.tune-settings input[type="range"]').each((e,a)=>{n.push($(a).val())}),window.electronAPI.send("toPlayer",["playTune",n]);let e=1;$(".tune-settings label").eq(0).addClass("blink"),blinkers=setInterval(()=>{e===n.length?($(".tune-settings label").removeClass("blink"),clearInterval(blinkers)):$(".tune-settings label").removeClass("blink").eq(e).addClass("blink"),e++},350)})},showErr=n=>{$(".error div").html(n).parent().addClass("show-error"),setTimeout(()=>{$(".error").removeClass("show-error")},4e3)};$(document).ready(()=>{window.electronAPI.receive("toWindow",n=>{"bar"===n[0]?nanobar.go(+n[1]):"configs"===n[0]?(changeLang(n[1].lang,!1,n[1]),nanobar=new Nanobar({classname:"nanobar",id:"nanobar",target:$(".header")[0]}),nanobar.go(0),replaceData.offlineFiles=n[1].offlineFiles,replaceData.offlineKKFiles=n[1].offlineKKFiles):"error"===n[0]?("failedToDownload"===n[1]&&nanobar.go(100),showErr(i18n(n[1]))):"downloadDone"===n[0]?"kk"===n[1]?replaceData.offlineKKFiles++:replaceData.offlineFiles++:"downloadRemoved"===n[0]?"kk"===n[1]?replaceData.offlineKKFiles--:replaceData.offlineFiles--:"downloadDoneAll"===n[0]?($(".settings .download").removeAttr("disabled"),$(".settings #downloadHourly").text(i18n($(".settings #downloadHourly").attr("data-i18n"))),$(".settings #downloadKK").text(i18n($(".settings #downloadKK").attr("data-i18n")))):"updateGame"===n[0]?$("#gameSelect").val(n[1]):"pause"===n[0]&&(paused=!0,pause(!0))})}),window.onerror=function(n,e,a,t,i){return console.error("Renderer Error:",n,"at",e,":",a,":",t,i),!1};