const storage=require("electron-json-storage"),fs=require("fs"),superagent=require("superagent"),Wad=window.Wad,AudioContext=window.AudioContext,kkSongs=require("../kk.json"),baseUrl="https://d17orwheorv96d.cloudfront.net";let chime,beep,sound,soundVol,soundGain,rain,rainVol,rainGain,game,hour,chimeInt,userSettingsPath,lang,keys,offlineFiles,offlineKKFiles,tune,tuneEnabled,beepTimeout,gameRain,peacefulRain,kkEnabled,kkSaturday,openOnStartup,preferNoDownload,latestVersion,currentVersion,soundSources=[],rainSources=[],grandFather=!1,paused=!1;const tunes=["G0","A1","B1","C1","D1","E1","F1","G1","A2","B2","C2","D2","E2"],tunesBeepMap=["G4","A4","B4","C5","D5","E5","F5","G5","A5","B5","C6","D6","E6"],games=["population-growing","population-growing-snowy","population-growing-cherry","population-growing-rainy","wild-world","wild-world-rainy","wild-world-snowy","new-leaf","new-leaf-rainy","new-leaf-snowy","new-horizons","new-horizons-rainy","new-horizons-snowy","pocket-camp"],convertGameToHuman=e=>{const a=e.split("-"),n=[];return a.forEach(e=>{n.push(e.substring(0,1).toUpperCase()+e.substring(1))}),n.join(" ")},soundLoaded=async(e,a=!0,n)=>new Promise(async o=>{if(paused)o();else{if(a){sound=e,sound.isSound=a,sound.start(),await fadeSound("sound",!0);const o=(n=n.replace("kk-slider-desktop","kk-slider")).substring(n.lastIndexOf("/")+1);window.electronAPI.send("playing",[convertGameToHuman(o.substring(0,o.lastIndexOf("-"))),o.substring(o.lastIndexOf("-")+1).replace(".ogg","")])}else rain=e,rain.start(),await fadeSound("rain",!0);o()}}),startAudio=async()=>(hour=null,paused=!1,timeCheck()),stopAudio=async(e="sound")=>new Promise(async a=>{if("rain"===e||"all"===e)if(rain){if(await fadeSound("rain",!1),rain){rain.stop(),rain=null;for(const e of rainSources)try{e.stop()}catch(e){}rainSources=[]}"rain"===e&&a("stopped")}else a("skip stop");if("sound"===e||"all"===e)if(window.electronAPI.send("playing",[]),sound){if(await fadeSound("sound",!1),sound){sound.removeEventListener("ended",kkEnded),sound.stop(),sound=null;for(const e of soundSources)try{e.stop()}catch(e){}soundSources=[]}a("stopped")}else a("skip stop")}),pauseClicked=async()=>paused?(paused=!1,playRain(),await startAudio(),"done"):(paused=!0,await stopAudio("all"),"done"),fadeSound=async(e="sound",a=!0)=>new Promise(async n=>{for(let o=0;o<=("sound"===e?100*soundVol:100*rainVol);o+=1)await new Promise(e=>setTimeout(e,2)),a&&("sound"===e?sound:rain)||!a?("sound"===e&&(soundGain.gain.value=a?o/100:soundVol-o/100),"rain"===e&&(rainGain.gain.value=a?o/100:rainVol-o/100)):n("skip"),(a&&o/100===("sound"===e?soundVol:rainVol)||!a&&0===("sound"===e?soundGain.gain.value:rainGain.gain.value))&&n("done")}),playSound=async e=>{if(!e)return;const a=new AudioContext,n=await fetch(e).then(e=>e.arrayBuffer()).then(e=>a.decodeAudioData(e)).catch(e=>console.error(e));if(n){const o=a.createBufferSource();soundSources.push(o),o.buffer=n,soundGain=a.createGain(),soundGain.gain.value=0,o.connect(soundGain).connect(a.destination),o.loop=!grandFather&&"kk-slider-desktop"!==game,"kk-slider-desktop"===game&&o.addEventListener("ended",kkEnded),await soundLoaded(o,!0,e)}else preferNoDownload?window.electronAPI.send("toWindow",["error","failedToLoadSound"]):fs.unlink(e,a=>{console.error(a),storage.remove(`meta-${e.split("/sound/")[1].replace(".ogg","")}`),window.electronAPI.send("toWindow",["downloadRemoved",e.includes("kk-slider")?"kk":"hourly"]),window.electronAPI.send("toWindow",["error","failedToLoadSound"])})},kkEnded=()=>{hour=null,timeCheck()},playRain=async()=>{const e=await getUrl(`${baseUrl}/rain/${gameRain?"game-rain":peacefulRain?"no-thunder-rain":"rain"}.ogg`);if(!e)return;const a=new AudioContext,n=a.createBufferSource();rainSources.push(n);const o=await fetch(e).then(e=>e.arrayBuffer()).then(e=>a.decodeAudioData(e)).catch(e=>console.error(e));n.buffer=o,rainGain=a.createGain(),rainGain.gain.value=0,n.connect(rainGain).connect(a.destination),n.loop=!grandFather,await soundLoaded(n,!1)},timeCheck=async()=>new Promise(async e=>{const a=getHour();if(paused||a===hour)e("paused || grandFather || newHour === hour");else{await stopAudio("sound"),hour&&hour!==a&&await playChime(tuneEnabled),hour=a,kkSaturday&&~["8pm","9pm","10pm","11pm"].indexOf(a)&&6===(new Date).getDay()?(game="kk-slider-desktop",window.electronAPI.send("toWindow",["updateGame",game])):kkSaturday&&"12am"===a&&0===(new Date).getDay()&&(game=storage.getSync("game").game||"new-leaf",window.electronAPI.send("toWindow",["updateGame",game]));const n="random"===game?games[~~(Math.random()*games.length)]:game;await playSound(await getUrl(`${baseUrl}/${n}/${"kk-slider-desktop"===n?kkEnabled[~~(Math.random()*kkEnabled.length)]:"pocket-camp"===n?hourToPocketCamp(hour):hour}.ogg`)),e("played")}}),toNewUrl=e=>{let a=e.split("/");return a=`${a[a.length-2]}-${a[a.length-1]}`.replace(".ogg",""),a},getUrl=async e=>{const a=toNewUrl(e),n=storage.getSync(`meta-${a}`).lastModified,o=await localSave(e,a,n);return"err"!==o&&"head fail"!==o&&"no headers error"!==o||n?"prefer no download"===o?e:`${userSettingsPath}/sound/${a}.ogg`:(a.includes("rain-")?window.electronAPI.send("toWindow",["error","failedToLoadRainSound"]):window.electronAPI.send("toWindow",["error","failedToLoadSound"]),"")},handleIpc=async e=>{const a=e[0];if(e.shift(),"userSettingsPath"===a)userSettingsPath=e[0],currentVersion=e[1],storage.setDataPath(e[0]),storage.keys((e,a)=>{keys=e?[]:a,doMain()});else if("musicVol"===a)soundGain.gain.value=+e[0]/100,chime.setVolume(+e[0]/100),soundVol=+e[0]/100,storage.set("soundVol",{volume:+e[0]});else if("rainVol"===a)rainGain.gain.value=+e[0]/100,rainVol=+e[0]/100,storage.set("rainVol",{volume:+e[0]});else if("grandFather"===a){grandFather=e[0],storage.set("grandFather",{enabled:e[0]});const a=getHour();hour=a;const n="random"===game?games[~~(Math.random()*games.length)]:game;await stopAudio("sound"),await playSound(await getUrl(`${baseUrl}/${n}/${"kk-slider-desktop"===n?kkEnabled[~~(Math.random()*kkEnabled.length)]:"pocket-camp"===n?hourToPocketCamp(hour):hour}.ogg`))}else if("game"===a){game=e[0],storage.set("game",{game:game});const a=getHour();hour=a;const n="random"===game?games[~~(Math.random()*games.length)]:game;await stopAudio("sound"),await playSound(await getUrl(`${baseUrl}/${n}/${"kk-slider-desktop"===n?kkEnabled[~~(Math.random()*kkEnabled.length)]:"pocket-camp"===n?hourToPocketCamp(hour):hour}.ogg`))}else if("tuneEnabled"===a)tuneEnabled=e[0],storage.set("tuneEnabled",{tuneEnabled:e[0]});else if("preferNoDownload"===a)preferNoDownload=e[0],storage.set("preferNoDownload",{preferNoDownload:e[0]});else if("tune"===a)tune=e[0],storage.set("tune",{tune:tune});else if("playNote"===a)await playBeep(e[0],350);else if("playTune"===a)await playBeeps(e[0]);else if("paused"===a)storage.set("paused",{paused:e[0]}),pauseClicked();else if("pauseIfPlaying"===a)paused||(storage.set("paused",{paused:!0}),pauseClicked(),window.electronAPI.send("toWindow",["pause"]));else if("downloadHourly"===a)await downloadHourly();else if("downloadKK"===a)await downloadKK();else if("gameRain"===a)gameRain=e[0],peacefulRain=!1,storage.set("gameRain",{enabled:e[0]}),storage.set("peacefulRain",{enabled:!1}),await stopAudio("rain"),await playRain();else if("peacefulRain"===a)peacefulRain=e[0],gameRain=!1,storage.set("peacefulRain",{enabled:e[0]}),storage.set("gameRain",{enabled:!1}),await stopAudio("rain"),await playRain();else if("kkEnabled"===a){if(kkEnabled=e[0],storage.set("kkEnabled",{songs:e[0]}),"kk-slider-desktop"===game){const e=getHour();hour=e;const a="random"===game?games[~~(Math.random()*games.length)]:game;await stopAudio("sound"),await playSound(await getUrl(`${baseUrl}/${a}/${"kk-slider-desktop"===a?kkEnabled[~~(Math.random()*kkEnabled.length)]:"pocket-camp"===a?hourToPocketCamp(hour):hour}.ogg`))}}else if("kkSaturday"===a){kkSaturday=e[0],storage.set("kkSaturday",{enabled:e[0]});const a=getHour();hour=a;const n="random"===game?games[~~(Math.random()*games.length)]:game;await stopAudio("sound"),await playSound(await getUrl(`${baseUrl}/${n}/${"kk-slider-desktop"===n?kkEnabled[~~(Math.random()*kkEnabled.length)]:"pocket-camp"===n?hourToPocketCamp(hour):hour}.ogg`))}else"openOnStartup"===a?(openOnStartup=e[0],storage.set("openOnStartup",{enabled:e[0]}),window.electronAPI.send("openOnStartup",[e[0]])):"lang"===a&&(lang=e[0],storage.set("lang",{lang:e[0]}))},localSave=async(e,a,n)=>await new Promise(o=>{preferNoDownload?o("prefer no download"):superagent.head(e).then(t=>{t.headers&&t.headers["last-modified"]?(n||(n=0),+new Date(n)!==+new Date(t.headers["last-modified"])?superagent.get(e).then(e=>{e.body&&userSettingsPath&&fs.mkdir(userSettingsPath+"/sound",{recursive:!0},n=>{if(n)return;const t=fs.createWriteStream(`${userSettingsPath}/sound/${a}.ogg`);t.write(e.body,"binary"),t.end(),t.on("finish",()=>{storage.set(`meta-${a}`,{lastModified:e.headers["last-modified"]}),window.electronAPI.send("toWindow",["downloadDone",a.includes("kk-slider")?"kk":"hourly"]),o("good!")}),t.on("error",e=>{o("err"),console.error(e)})})}).catch(e=>{o("err"),console.error(e)}):o("already obtained")):o("no headers err")}).catch(e=>{o("head fail"),console.error(e)})}),progress=e=>{window.electronAPI.send("toWindow",["bar",e])},getHour=()=>{const e=(new Date).getHours();return"population-growing-rainy"===game?"12am":`${(e+24)%12||12}${e>=12?"pm":"am"}`},doTick=async()=>{paused||await timeCheck(),setTimeout(()=>{doTick()},5e3)},doMain=()=>{soundVol=storage.getSync("soundVol").volume,rainVol=storage.getSync("rainVol").volume,grandFather=storage.getSync("grandFather").enabled,game=storage.getSync("game").game,lang=storage.getSync("lang").lang,tuneEnabled=storage.getSync("tuneEnabled").tuneEnabled,preferNoDownload=storage.getSync("preferNoDownload").preferNoDownload,tune=storage.getSync("tune").tune,paused=storage.getSync("paused").paused,gameRain=storage.getSync("gameRain").enabled,peacefulRain=storage.getSync("peacefulRain").enabled,kkEnabled=storage.getSync("kkEnabled").songs,kkSaturday=storage.getSync("kkSaturday").enabled,openOnStartup=storage.getSync("openOnStartup").enabled,latestVersion=storage.getSync("latestVersion").version;let e=!1;offlineFiles=keys.filter(e=>e.includes("meta-")&&!e.includes("meta-kk-slider")&&!e.includes("meta-rain")).length,offlineKKFiles=keys.filter(e=>e.includes("meta-kk-slider")).length,latestVersion!==currentVersion&&(storage.set("latestVersion",{version:currentVersion}),e=!0),void 0===paused&&(paused=!1),void 0===soundVol?soundVol=.5:soundVol/=100,void 0===rainVol?rainVol=.5:rainVol/=100,void 0===grandFather&&(grandFather=!1),void 0===game&&(game="new-leaf"),void 0===lang&&(lang="en"),void 0===tuneEnabled&&(tuneEnabled=!0),void 0===preferNoDownload&&(preferNoDownload=!1),void 0===gameRain&&(gameRain=!1),void 0===peacefulRain&&(peacefulRain=!1),void 0===kkEnabled&&(kkEnabled=kkSongs),void 0===kkSaturday&&(kkSaturday=!1),void 0===openOnStartup&&(openOnStartup=!1),void 0===tune&&(tune=["G1","E2","-","G1","F1","D2","-","B2","C2","zZz","?","zZz","C1","-","zZz","zZz"]),window.electronAPI.send("toWindow",["configs",{soundVol:100*soundVol,rainVol:100*rainVol,grandFather:grandFather,game:game,lang:lang,offlineFiles:offlineFiles,offlineKKFiles:offlineKKFiles,tune:tune,tuneEnabled:tuneEnabled,preferNoDownload:preferNoDownload,paused:paused,gameRain:gameRain,peacefulRain:peacefulRain,kkEnabled:kkEnabled,kkSaturday:kkSaturday,openOnStartup:openOnStartup,showChangelog:e}]),chime=new Wad({source:"chime.ogg",sprite:{G0:[0,4],A1:[4,8],B1:[8,12],C1:[12,16],D1:[16,20],E1:[20,24],F1:[24,28],G1:[28,32],A2:[32,36],B2:[36,40],C2:[40,44],D2:[44,48],E2:[48,52]},volume:soundVol}),beep=new Wad({source:"triangle",env:{hold:-1,release:.2,sustain:.1},pitch:"G4",volume:.5}),setTimeout(async()=>{await playRain(),doTick()},0)},hourToPocketCamp=e=>~["5am","6am","7am","8am"].indexOf(e)?"morning":~["9am","10am","11am","12pm","1pm","2pm","3pm","4pm"].indexOf(e)?"day":~["5pm","6pm"].indexOf(e)?"evening":~["7pm","8pm","9pm","10pm","11pm","12am","1am","2am","3am","4am"].indexOf(e)?"night":void 0,downloadHourly=async()=>{let e=0,a=0;const n=100/(24*(games.length-1)+4),o=["12am","1am","2am","3am","4am","5am","6am","7am","8am","9am","10am","11am","12pm","1pm","2pm","3pm","4pm","5pm","6pm","7pm","8pm","9pm","10pm","11pm"],t=["morning","day","evening","night"];let r=1e3,s=!1;for(const i of games){if(s)return;await new Promise(d=>{setTimeout(async()=>{for(let l=0;l<("pocket-camp"===i?4:24);l++){if(a>=3){s=!0,window.electronAPI.send("toWindow",["error","failedToDownload"]),d();break}await new Promise(e=>setTimeout(()=>e(),r));const u=`${baseUrl}/${i}/${"pocket-camp"===i?t[l]:o[l]}.ogg`,g=toNewUrl(u),p=storage.getSync(`meta-${g}`).lastModified;p?r=0:(r=1e3,"err"===await localSave(u,g,p)&&a++),e+=n,progress(e),("pocket-camp"===i&&3===l||23===l)&&d()}},0)})}window.electronAPI.send("toWindow",["downloadDoneAll"]),progress(100)},downloadKK=async()=>{let e=0,a=0;const n=100/kkSongs.length;let o=1e3;for(const t of kkSongs){if(a>=3){window.electronAPI.send("toWindow",["error","failedToDownload"]);break}await new Promise(r=>{setTimeout(async()=>{await new Promise(e=>setTimeout(()=>e(),o));const s=`${baseUrl}/kk-slider-desktop/${t}.ogg`,i=toNewUrl(s),d=storage.getSync(`meta-${i}`).lastModified;d?o=0:(o=1e3,"err"===await localSave(s,i,d)&&a++),e+=n,progress(e),r()},0)})}window.electronAPI.send("toWindow",["downloadDoneAll"]),progress(100)},playChime=async e=>await new Promise(a=>{if(!e)return a("done");let n=0;chimeInt=setInterval(()=>{chime.setVolume(soundVol),"zZz"!==tune[n]&&"-"!==tune[n]&&"?"!==tune[n]?chime[tune[n]].play():"?"===tune[n]&&chime[tunes[~~(Math.random()*tunes.length)]].play(),n++,n===tune.length&&(fadeAndStopChime(),a("done"),clearInterval(chimeInt))},900)}),fadeAndStopChime=async()=>{for(let e=100*soundVol;e>=0;e--)await new Promise(e=>setTimeout(()=>e(),5)),chime.setVolume(e/100);chime.stop()},playBeeps=async e=>{for(const[a,n]of e.entries()){let o=350;if(e[a+1]&&"2"===e[a+1]){const n=e.slice(a+1);let t=1;for(const e of n){if("2"!==e)break;t++}o=350*t}await playBeep(n,o)}},playBeep=async(e,a)=>await new Promise(n=>{let o=0;"1"===e?beepTimeout=setTimeout(()=>{beep.stop(),clearTimeout(beepTimeout),n("done")},a):"2"===e?n("done"):(o="16"===e?~~(13*Math.random()):+e-3,clearTimeout(beepTimeout),beep.stop(),beep.play({pitch:tunesBeepMap[o]}),beepTimeout=setTimeout(()=>{beep.stop(),clearTimeout(beepTimeout),n("done")},a))});window.electronAPI.receive("toPlayer",handleIpc),window.electronAPI.send("playerLoaded");